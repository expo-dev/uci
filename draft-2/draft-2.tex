\includeruby color.rb
\includeruby syntax.rb
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\XeTeXuseglyphmetrics=1
%
\def\ldfont     #1#2#3{"#1/S=#2:mapping=tex-text#3"          at #2 pt}%
\def\ldifont    #1#2#3{"#1/S=#2/I:mapping=tex-text#3"        at #2 pt}%
\def\ldbfont    #1#2#3{"#1/S=#2/B:mapping=tex-text#3"        at #2 pt}%
\def\ldbifont   #1#2#3{"#1/S=#2/BI:mapping=tex-text#3"       at #2 pt}%
\def\ldcapfont  #1#2#3{"#1/S=#2:mapping=tex-text:+smcp#3"    at #2 pt}%
\def\ldicapfont #1#2#3{"#1/S=#2/I:mapping=tex-text:+smcp#3"  at #2 pt}%
\def\ldbcapfont #1#2#3{"#1/S=#2/B:mapping=tex-text:+smcp#3"  at #2 pt}%
\def\ldbicapfont#1#2#3{"#1/S=#2/BI:mapping=tex-text:+smcp#3" at #2 pt}%
%
\def\basefamily{Alegreya Sans}%
\def\basesize{11}%
\def\basefeat{:+liga:+clig:+calt:+onum:+pnum}%
\font\rm  =\ldfont    {\basefamily}{\basesize}{\basefeat}%
\font\it  =\ldifont   {\basefamily}{\basesize}{\basefeat}%
\font\bf  =\ldbfont   {\basefamily}{\basesize}{\basefeat}%
\font\caps=\ldcapfont {\basefamily}{\basesize}{\basefeat}%
\font\icap=\ldicapfont{\basefamily}{\basesize}{\basefeat}%
%
\def\codefamily{JetBrains Mono}%
\def\codesize{9.25}%
\def\codefeat{:+liga:+clig:+calt:lnum:+tnum}%
%
\font\fw =\ldfont {\codefamily}{\codesize}{\codefeat}%
\font\ifw=\ldifont{\codefamily}{\codesize}{\codefeat}%
%
\def\fs{%
  \spaceskip=0.5em
  \xspaceskip=0.5em
}%
%
\font\noto    ="Noto Sans:mapping=tex-text"      at 10 pt
\font\notomono="Noto Sans Mono:mapping=tex-text" at 10 pt
%
\rm
\spaceskip =0.3em plus 0.15em minus 0.15em
\xspaceskip=0.5em plus 0.25em minus 0.25em
%
\def\lcap#1{%
  \font\localfont=\ldcapfont{\basefamily}{\basesize}{\basefeat:letterspace=#1}%
  \localfont
  \dimen0=0.0625\fontdimen2\localfont
  \multiply\dimen0 by #1
  \advance\dimen0 by \fontdimen2\localfont
  \spaceskip =   \dimen0 plus 0.5\dimen0 minus 0.5\dimen0
  \xspaceskip=1.5\dimen0 plus 0.5\dimen0 minus 0.5\dimen0
}%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newbox\testbox
\newcount\testem
\newcount\testwd
\def\setrpcode#1#2{%
  \setbox\testbox=\hbox{\char#2}%
  \testwd=\wd\testbox
  \multiply\testwd by 1000
  \divide\testwd by\testem
  \rpcode#1 U#2 \the\testwd
}%
\def\setlpcode#1#2{%
  \setbox\testbox=\hbox{\char#2}%
  \testwd=\wd\testbox
  \multiply\testwd by 1000
  \divide\testwd by\testem
  \lpcode#1 U#2 \the\testwd
}%
\def\setpcodes#1{%
  {#1%
    \setbox\testbox=\hbox{\kern1em}%
    \testem=\wd\testbox
    \setrpcode{#1}{"0021}% exclamation mark
    \setlpcode{#1}{"0027}% apostrophe
    \setlpcode{#1}{"0028}% left parenthesis
    \setrpcode{#1}{"0029}% right parenthesis
    \setrpcode{#1}{"002A}% asterisk
    \setrpcode{#1}{"002C}% comma
    \setrpcode{#1}{"002D}% hyphen
    \setrpcode{#1}{"002E}% full stop
    \setrpcode{#1}{"003B}% semicolon
    \setrpcode{#1}{"003A}% colon
    \setrpcode{#1}{"003F}% question mark
    \setlpcode{#1}{"005B}% left square bracket
    \setrpcode{#1}{"005D}% right square bracket
    \setlpcode{#1}{"2018}% left single quote
    \setrpcode{#1}{"2019}% right single quote
    \setlpcode{#1}{"201C}% left double quote
    \setrpcode{#1}{"201D}% right double quote
  }%
}%
\XeTeXprotrudechars=2
\setpcodes{\rm}%
\setpcodes{\it}%
\setpcodes{\bf}%
\setpcodes{\caps}%
\setpcodes{\icap}%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\def\url#1#2{%
  \special{pdf:bann <<
    /Subtype /Link
    /A << % Action
      /S /URI % Subtype
      /URI (#1)
    >>
    /Border [ 0 0 0 ] % [ horiz corner radius, vert corner radius, width ]
    /C [ 1 0 0 ] % Color [ r, g, b ]
  >>}%
  #2\special{pdf:eann}%
}%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\def\qt{\kern -1.0pt}%
\def\ot{\kern  0.5pt}%
\def\pt{\kern  1.0pt}%
\def\dt{\kern  2.0pt}%
\def\fem{\hskip 0.200em}%
\def\qem{\hskip 0.250em}%
\def\tem{\hskip 0.333em}%
\def\hem{\hskip 0.500em}%
\def\em {\hskip 1.000em}%
\def\dem{\hskip 2.000em}%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\beginruby
  pageW   = 210
  pageH   = 297
  marginL =  50
  marginR =  50
  marginT =  38.5
  marginB =  38.5
  hoffset = (marginL - 25.4).round(3)
  voffset = (marginT - 25.4).round(3)
  hsize   = (pageW - marginL - marginR).round(3)
  vsize   = (pageH - marginT - marginB).round(3)
\endruby
\pdfpagewidth\r{pageW}mm
\pdfpageheight=\r{pageH}mm
\hoffset=\r{hoffset}mm
\voffset=\r{voffset}mm
\hsize=\r{hsize}mm
\vsize=\r{vsize}mm
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\pretolerance=200
\tolerance=200
\baselineskip=16pt
\parskip=8pt
\parindent=0pt
\raggedbottom
\nopagenumbers
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\beginruby
  # Color Boxes
    grey_bg = lch(0.96, 0.0  ,   0);   grey_rbn = lch(0.70, 0.0  ,   0)
     red_bg = lch(0.96, 0.018,  15);    red_rbn = lch(0.70, 0.18 ,  15)
  yellow_bg = lch(0.97, 0.018,  90); yellow_rbn = lch(0.85, 0.15 ,  90)
   green_bg = lch(0.96, 0.018, 145);  green_rbn = lch(0.75, 0.15 , 145)
    blue_bg = lch(0.96, 0.018, 270);   blue_rbn = lch(0.70, 0.15 , 270)
  purple_bg = lch(0.96, 0.018, 330); purple_rbn = lch(0.70, 0.15 , 330)

  # Body copy
     red_fg = lch(0.6, 0.2 ,  30  )
    teal_fg = lch(0.6, 0.1 , 180  )
  purple_fg = lch(0.5, 0.25, 292.5)
    grey_fg = lch(0.5, 0.0 ,   0  )
   label_fg = lch(0.6, 0.0 ,   0  )
  ltgrey_fg = lch(0.7, 0.0 ,   0  )

  # Pseudocode
  amber_fg = lch(0.7, 0.125,  75)
  green_fg = lch(0.6, 0.15 , 150)
   blue_fg = lch(0.5, 0.2  , 270)
  lilac_fg = lch(0.6, 0.2  , 300)
\endruby
%
\newtoks\restorecolor \restorecolor={0 0 0}%
%
\long\def\color#1#2{%
  {\restorecolor={#1}\special{color rgb #1}#2}%
  \special{color rgb \the\restorecolor}%
}%
%
\long\def\colorbox#1#2#3{%
  \par
  % Set the contents of the box
  \advance\hsize by -2em
  \setbox0 = \vbox{#3}%
  \advance\hsize by 2em
  % Insert the usual interline glue
  \ifdim \prevdepth > -1000pt
    \vskip-\prevdepth
    \vskip\baselineskip
  \fi
  % Insert an extra half of a baselineskip above
  \vskip0.5\baselineskip
  % Calculate dimensions
  \dimen0 = \ht0
  \dimen1 = \dp0
  \advance\dimen0 by 0.25\baselineskip % midway along half-baselineskip above
  \advance\dimen0 by 0.25\baselineskip % adjust the upper edge and
  \advance\dimen1 by 0.20\baselineskip %   lower edge to be perceptually correct
  \advance\dimen1 by 0.25\baselineskip % midway along half-baselineskip below
  % Insert the background
  \kern -0.25\baselineskip % midway along extra
  \kern -0.25\baselineskip % adjustment
  \color{#1}{\hrule width \hsize height \dimen0 depth \dimen1}%
  \kern -\ht0
  \kern -\dp0
  \kern -0.20\baselineskip % adjustment
  \kern -0.25\baselineskip % midway along extra
  % Insert the ribbon
  \kern -0.25\baselineskip % midway along extra
  \kern -0.25\baselineskip % adjustment
  \color{#2}{\hrule width 0.5em height \dimen0 depth \dimen1}%
  \kern -\ht0
  \kern -\dp0
  \kern -0.20\baselineskip % adjustment
  \kern -0.25\baselineskip % midway along extra
  % Insert the box
  \hbox{\hskip1em\box0}
  % Insert an extra half of a baselineskip below
  \vskip0.5\baselineskip
}%
\long\def  \greybox#1{\colorbox{\r{  grey_bg}}{\r{  grey_rbn}}{#1}}%
\long\def\purplebox#1{\colorbox{\r{purple_bg}}{\r{purple_rbn}}{#1}}%
\long\def  \bluebox#1{\colorbox{\r{  blue_bg}}{\r{  blue_rbn}}{#1}}%
\long\def \greenbox#1{\colorbox{\r{ green_bg}}{\r{ green_rbn}}{#1}}%
\long\def\yellowbox#1{\colorbox{\r{yellow_bg}}{\r{yellow_rbn}}{#1}}%
\long\def   \redbox#1{\colorbox{\r{   red_bg}}{\r{   red_rbn}}{#1}}%
%
\long\def\label  #1{\color{\r{ label_fg}}{#1}}%
\long\def\term   #1{\color{\r{purple_fg}}{#1}}%
\long\def\comment#1{\color{\r{  grey_fg}}{{\noto ※ }#1}}%
\long\def\s      #1{\color{\r{  teal_fg}}{\fw #1}}%
%
\def\hex#1{{\fw\color{\r{ltgrey_fg}}{x}#1}}%
\def\uni#1{{\caps u+#1}}%
%
\def\ellipsis{.\ot.\ot.}
%
\newcount\majorcount
\newcount\minorcount
\def\major{%
  \advance\majorcount by 1
  \minorcount=0
  \leavevmode
  \llap{\label{\the\majorcount}\hem}%
}%
\def\minor{%
  \advance\minorcount by 1
  \leavevmode
  \llap{\label{\the\majorcount·\the\minorcount}\hem}%
}%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\def\gets{<-}%
\def\to  {->}%
\def\then{=>}%
%
\setbox0=\hbox{\fw ()[]\char"7B\char"7D\it ()[]\char"7B\char"7D}%
\newdimen\strutht
\newdimen\strutdp
\strutht=\ht0
\strutdp=\dp0
\dimen0=\baselineskip
\advance\dimen0 by -\strutht
\advance\dimen0 by -\strutdp
\divide\dimen0 by 2
\advance\strutht by \dimen0
\advance\strutdp by \dimen0
\def\strut{\vrule width 0pt height \strutht depth \strutdp}%
%
\def\tab{%
  \kern 0.75ex
  \color{\r{ltgrey_fg}}{\vrule width 0.5pt}%
  \kern -0.5pt
  \kern -0.75ex
  \kern 3ex
}%
%
\def\kwd  #1{\color{\r{  blue_fg}}{#1}}% def, return, break, error
\def\flow #1{\color{\r{ amber_fg}}{#1}}% repeat, if, then, match
\def\liter#1{\color{\r{   red_fg}}{#1}}% numeric
\def\const#1{\color{\r{ lilac_fg}}{#1}}% empty, eof
\def\func #1{\color{\r{ green_fg}}{#1}}%
\def\var  #1{{\ifw #1}}%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
\centerline{\lcap8 UNIVERSAL CHESS INTERFACE}
\centerline{\lcap4 august 2024 • draft}

{\bf Introduction}

This specification governs the interaction between two processes named the
{\it client} and the {\it engine}. Graphical interfaces, terminal emulators,
and scripts and utilities are examples of clients. Normative text begins with
section 1 {\it Definitions}.

{\bf Getting Started}

{\it This section needs to be written! It should contain enough for a beginner
to add basic {\icap uci} support to their engine.}

{\bf Conventions}

An {\fw\color{\r{ltgrey_fg}}{x}} preceding a number indicates that it is written
in hexadecimal; for example, \hex{10} = 16. Sequences of Unicode scalar values
encoded in {\caps utf-8} are set in teal; for example, \s{u¢i} = ⟨\pt\hex{75},
\hex{c2}, \hex{a2}, \hex{69}⟩\pt.

Special terms defined by the specification are set in \term{purple} when they
are first introduced and inline comments are set \comment{after a reference
mark}.
\vskip-\parskip
\bluebox{A blue box is used to describe a convention that clients and engines
are encouraged to follow, usually to do with the interpretation or meaning of
the messages that clients and engines send. A blue box is also used to provide
a recommendation, usually to do with implementation-defined behavior.}
\vskip-\parskip
\greybox{A grey box is used to provide an explanative note or comment.}
\vskip-\parskip
\greenbox{A green box is used to provide an example of conforming behavior.}
\vskip-\parskip
Text within colored boxes is nonnormative.

\major{\bf Definitions}

\minor A \term{violation} is any violation, by the client or engine, of the
requirements of the specification. When a violation occurs, or when the
requirements of the specification are otherwise not met, the specification
imposes no further requirements on the behavior of the client or engine.

\minor An \term{error} is a condition that should not occur but that is still
governed by the specification.

\minor The engine's standard input and output must be open file descriptors and
the engine's standard error must be an open file descriptor until closed by the
engine. The sequence of bytes that the client sends to the engine via the
engine's standard input is the \term{client byte sequence}. The sequence of
bytes that the engine sends to the client via the engine's standard output
is the \term{engine byte sequence}.
\vskip-\parskip
\greybox{There are no requirements for an engine's standard error except that it
be open. For example, the engine's standard error may be directed to a null
file, to the client's standard output or standard error, or to a log file. There
are accordingly no restrictions on the sequence of bytes that the engine writes
to its standard error.}

\minor The client byte sequence and engine byte sequence must be valid
\hbox{\caps utf-8}. The sequence of scalar values encoded by the client byte
sequence is the \term{client scalar sequence} and the sequence encoded by the
engine byte sequence is the \term{engine scalar sequence}.
\vskip-\parskip
\greybox{{\caps Utf-8} is required for client−engine communication, but the
client and engine may use different encodings for other interfaces, such as
specifying file system paths to the operating system in order to read tablebase
files. For example, the client and engine may be communicating over a network
connexion and the client may be running on Linux (where paths are arbitrary
byte sequences that do not contain \hex{00} or \hex{2f}) but the engine may be
running on Windows (for which {\caps ntfs} is a common filesystem, which stores
file names in {\caps utf-16}, but where older libraries or {\caps api}s may
expect paths encoded in the local code page).}

\minor A \term{message terminator} is the pair ⟨\uni{000d carriage return},
\uni{000a line feed}⟩ or \uni{000a} alone when it is not preceded by \uni{000d}.

\minor Message terminators divide the client and engine scalar sequences into
\term{messages}; that is, a message is a (possibly empty) subsequence of scalar
values that does not contain a message terminator and every scalar value of
the client and engine scalar sequences is either part of a message or part of
a message terminator. The messages within the client sequence are \term{client
messages} and the messages within the engine sequence are \term{engine
messages}.

\vskip\parskip
\beginruby
format("let @read_byte! : File_Descriptor -> Byte | EOF")
\endruby
\vskip\parskip
\beginruby
format(%q{
def trimCR('seq : List(Byte)) : List(Byte)
  if empty?('seq) or last('seq) ≠ `0d then return 'seq
  return withoutLast('seq)
})
\endruby
\vskip\parskip
\beginruby
format(%q{
def read_message!('fd : File_Descriptor) : List(Byte) | EOF
  'seq <- empty
  repeat
    match read_byte!('fd)
      eof => return (\pt if empty?('seq) then eof else 'seq\pt)
      `0a => return trimCR('seq)
      'val => append!('seq, 'val\pt)
})
\endruby

\minor A message must not contain \uni{000d}; that is, every occurence
of \uni{000d} in the input or output sequence must be part of a message
terminator.

\minor The scalar value \uni{0020 space} divides messages into \term{tokens},
that is, a token is a non-empty sequence of scalar values that are not
\uni{0020}, and every scalar value of a message is either part of a token
or is \uni{0020}.
\vskip-\parskip
\greybox{In some cases, only the beginning of a message will be viewed as a
collection of tokens and the remainder will be viewed as a continuous sequence
of scalar values.}

\beginruby
format(%q{
def get_token!('seq : List(Byte)) -> List(Byte) | None
  repeat
    if empty?('seq) then return none
    if first('seq) ≠ `20 then break
    removeFirst!('seq)
  'tok <- empty
  repeat
    append!('tok, first('seq))
    removeFirst!('seq)
    if empty?('seq) then return 'tok
    if first('seq) = `20 then break
  repeat
    removeFirst!('seq)
    if empty?('seq) then return 'tok
    if first('seq) ≠ `20 then break
  return 'tok
})
\endruby

\vfil\break
\minor A \term{position} is a tuple with the following fields:

{\leftskip=3ex

\vskip-0.5\parskip An 8×8 array of elements, each of which is either empty
or a color−\allowbreak kind pair (where the \term{color} is white or black
and the \term{kind} is king, queen, rook, knight, bishop, or pawn). This
array is called the \term{board} and is indexed along one axis by the letters
“a” through “h” inclusive and along the other axis by the numerals “1” through
“8”. A color−\allowbreak kind pair is called a \term{piece}.

\vskip-0.5\parskip A color, white or black, called the \term{side to move}.

\vskip-0.5\parskip A collection of values, called the \term{rights}, which may
be empty or include one or more of the following: the white kingside castling
right, the white queenside castling right, the black kingside castling right,
and the black queenside castling right.

\vskip-0.5\parskip A value called the \term{en passant target}, which is either
none or one of a3, b3, \ellipsis\ot, h3, or a6, b6, \ellipsis\ot, h6.

\vskip-0.5\parskip A nonnegative integer called the \term{depth from zeroing},
which is 150 or less. \comment{This is the number of moves that have been played
(none of which are captures or pawn moves) since the last capture or pawn move,
measured in ply.}

}

\vskip-0.5\parskip The \term{side waiting} in a position is the opposite color
of the side to move.

\minor For a given position, a king is \term{in check} if it is attacked by one
or more pieces of the opposite color, where “attacked” is defined analogously to
article 3.1.2 of the 2023 {\caps fide} Laws of Chess.

\minor A position is \term{legal} if the following conditions are all satisfied:

{\leftskip=3ex

\vskip-0.5\parskip The board contains exactly one white king and one black king.

\vskip-0.5\parskip The board does not contain any pawns at indices
a1, b1, \ellipsis\ot, h1 and does not contain any pawns at indices
a8, b8, \ellipsis\ot, h8.

\vskip-0.5\parskip If the rights include the white kingside castling right, the
white king is at index e1 and there is a white rook at index h1. If the rights
include the white queenside castling right, the white king is at index e1 and
there is a white rook at index a1. If the rights include the black kingside
castling right, the black king is at index e8 and there is a black rook at
index h8. If the rights include the black queenside castling right, the black
king is at index e8 and there is a black rook at index a8.

\vskip-0.5\parskip If the en passant target is {\it n}\ot3 for some {\it n},
then the side to move is black, there is a white pawn at index {\it n}\ot4, and
at {\it n}\ot2 and {\it n}\ot3 the board is empty. If the en passant target is
{\it n}\ot6 for some {\it n}, then the side to move is white, there is a black
pawn at index {\it n}\ot5, and at {\it n}\ot6 and {\it n}\ot7 the board is
empty.

\vskip-0.5\parskip The king of the color of the side waiting is not in check.

}

\vskip-\parskip
\greybox{A legal position as defined here need not be reachable from the
starting position.}

\minor A \term{move} is either a tuple with two fields – a board index
called the \term{source} and a board index called the \term{destination}
– or a tuple with three fields: a source, a destination, and a kind called
the \term{promotion kind} that is either queen, rook, bishop, or knight.

\minor For a given position {\it P}, a move {\it M} is \term{legal} and the
position {\it Q} \term{immediately follows} when {\it M} is \term{applied} if
{\it P}, {\it M}, and {\it Q} fulfill requirements analogous to articles 3.1
through 3.9 inclusive of the 2023 {\caps fide} Laws of Chess, except

{\leftskip=3ex

\vskip-0.5\parskip the requirement for a pawn to advance by two is instead that
the pawn is white and its index is one of a2, b2, \ellipsis\ot, h2 or that the
pawn is black and its index is one of a7, b7, \ellipsis\ot, h7, and

\vskip-0.5\parskip the requirement for an en passant capture is instead that
the en passant target is not none and the capturing pawn attacks the en passant
target.

}

In particular, when {\it M} is legal, there is a piece of the color of the side
to move in the board of {\it P} at the source of {\it M} and there is a piece
of the same color and kind (or a piece of the same color and the promotion kind
of {\it M}) in the board of {\it Q} at the destination of {\it M}.

The side to move of {\it Q} is the opposite color of the the side to move of
{\it P}. If {\it M} is a king or rook move, the rights of {\it Q} do not include
the corresponding castling right or castling rights. If {\it M} advances a pawn
by two, the en passant target of {\it Q} is the index between the source and
destination of {\it M}. If {\it M} is a capture or a pawn move, the depth from
zeroing of {\it Q} is zero; otherwise, the depth from zeroing of {\it Q} is the
depth from zeroing of {\it P} plus one.

\def\rjust#1#2{\hbox to #1{\hfil #2}}
\def\alt{\vrule height 7.125pt depth 1.375pt width 0.7pt}

\minor A \term{Forsyth–Edwards Notation ({\caps fen}) sequence} is a sequence
of six tokens ⟨{\it board, side to move, rights, {\icap ep} target,
{\icap dfz}, move number}⟩ of the form\par
%
\dimen0=5em
\vskip-0.5\parskip\hskip3ex\rjust{\dimen0}{\it board}
  \dt=\dt\ \r{(['{\it row}']*8).join('\pt\s/\pt')}\par
\vskip-\parskip\hskip3ex\rjust{\dimen0}{\it row}
  \dt=\dt\ \s8 \alt\ [\s1–\s8\s{KQRBNPkqrbnp}]+\par
\vskip-\parskip\hskip3ex\rjust{\dimen0}{\it side to move}
  \dt=\dt\ \s w \alt\ \s b\par
\vskip-\parskip\hskip3ex\rjust{\dimen0}{\it rights}
  \dt=\dt\ \s- \alt\ \s K?\pt\s Q?\pt\s k?\pt\s q?\par
  % \lower0.5pt\hbox{\notomono ∩} [\s{KQkq}]+)\par
\vskip-\parskip\hskip3ex\rjust{\dimen0}{\it {\icap ep} target}
  \dt=\dt\ \s- \alt\ [\s a–\s h][\s{36}]\par
\vskip-\parskip\hskip3ex\rjust{\dimen0}{\icap dfz}
  \dt=\dt\ \s0 \alt\ [\s1–\s9][\s0–\s9]\lower0.25ex\hbox{*}\par
\vskip-\parskip\hskip3ex\rjust{\dimen0}{\it move number}
  \dt=\dt\ [\s1–\s9][\s0–\s9]\lower0.25ex\hbox{*}\par
\vskip-\parskip\hskip3ex
  \comment{The dash “\s-” is \uni{002d hyphen-minus}.}

\vskip-0.5\parskip with the following additional constraints:

{\leftskip=3ex

\vskip-0.5\parskip In each {\it row}, numerals must not be adjacent; that is,
there must not be two or more immediately consecutive numerals.

\vskip-0.5\parskip For each {\it row},
map \s K,\pt\s Q, \ellipsis\ot,\pt\s p to 1,
map \s1,\pt\s2, \ellipsis\ot,\pt\s8 to 1,\pt2,\pt.\ot.\ot.,\pt8,
and then define the width as the sum of these numbers.
For each {\it row}, the width must be 8.

\vskip-0.5\parskip The scalar values \s K and \s k must each occur exactly
once in the {\it board}.

\vskip-0.5\parskip The scalar value \s P must not occur in the first {\it row}
and must not occur in the last {\it row}, and likewise for the scalar value
\s p.

\vskip-0.5\parskip The {\icap dfz} token interpreted as a decimal integer must
be 150 or less.

\vskip-0.5\parskip The {\it move number} token interpreted as a decimal integer
must be less than 10\pt000.\par}

\minor An {\caps fen} sequence \term{describes} a position if it maps to the
position in a manner analogous to that described in article 16.1.3 of the
Portable Game Notation Specification.

\minor The \term{starting position} is the position described by the {\caps fen}
sequence\hfil\penalty-10000
\hbox{\s{rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1}}.

\minor A \term{move token} is a token of the form
[\s a–\s h][\s1–\s8][\s a–\s h][\s1–\s8] or
{\it n}\ot\s7\ot{\it n}\ot\s8[\s{qrbn}] or
{\it n}\ot\s2\ot{\it n}\ot\s1[\s{qrbn}], where {\it n} is one of \s a, \s b,
\ellipsis\ot, \s h.

% \major{\bf Client Messages}

% \major{\bf Engine Messages}

% \major{\bf States and Transitions}

% \major{\bf Notation}

\bye
